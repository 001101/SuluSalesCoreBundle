define(["text!sulusalescore/components/item-table/item.form.html","text!sulusalescore/components/item-table/item.row.html","text!sulusalescore/components/item-table/item.row-head.html"],function(a,b,c){"use strict";var d={data:[],editable:!0},e={formId:"#item-table-form",listClass:".item-table-list",productSearchClass:".product-search",rowIdPrefix:"item-table-row-",productsUrl:"/admin/api/products?flat=true&searchFields=number,name&fields=id,name,number",productUrl:"/admin/api/products/",rowClass:".item-table-row",quantityRowClass:".item-quantity",quantityInput:".item-quantity input",priceRowClass:".item-price",priceInput:".item-price input",discountRowClass:".item-discount",discountInput:".item-discount input",globalPriceTableClass:".global-price-table",overallEmptyString:"-"},f={rowClass:null,id:null,rowNumber:null,rowId:"",name:"",number:"",quantity:"",quantityUnit:"pc",price:"",discount:null,overallPrice:"",currency:"EUR",useProductsPrice:!1,tax:0},g={priceRow:function(a,b){return["<tr>","   <td>",a,"   </td>","   <td>",b,"   </td>","</tr>"].join("")}},h="sulu.item-table.",i=h+"changed",j=function(){return{rowClass:"header",name:this.sandbox.translate("salescore.item.product"),number:this.sandbox.translate("salescore.item.number"),quantity:this.sandbox.translate("salescore.item.quantity"),quantityUnit:this.sandbox.translate("salescore.item.unit"),price:this.sandbox.translate("salescore.item.price"),discount:this.sandbox.translate("salescore.item.discount"),overallPrice:this.sandbox.translate("salescore.item.overallValue")}},k=function(){},l=function(){this.sandbox.dom.on(this.$el,"click",C.bind(this),".add-row"),this.sandbox.dom.on(this.$el,"click",z.bind(this),".remove-row"),this.sandbox.dom.on(this.$el,"data-changed",function(a){var b=a.items||[];K.call(this,b)}.bind(this)),this.sandbox.dom.on(this.$el,"change",m.bind(this),e.quantityInput),this.sandbox.dom.on(this.$el,"change",n.bind(this),e.priceInput),this.sandbox.dom.on(this.$el,"change",o.bind(this),e.discountInput)},m=function(a){var b=p.call(this,a).id;this.items[b].quantity=this.sandbox.dom.val(a.target),O.call(this),q.call(this,b),r.call(this),this.sandbox.emit(i)},n=function(a){var b=p.call(this,a).id;this.items[b].price=this.sandbox.dom.val(a.target),O.call(this),q.call(this,b),r.call(this),this.sandbox.emit(i)},o=function(a){var b=p.call(this,a).id;this.items[b].discount=this.sandbox.dom.val(a.target),O.call(this),q.call(this,b),r.call(this),this.sandbox.emit(i)},p=function(a){var b=this.sandbox.dom.closest(a.target,".item-table-row"),c=this.sandbox.dom.attr(b,"id");return{row:b,id:c}},q=function(a){var b=this.$find("#"+a),c=this.items[a],d=this.sandbox.dom.find(".item-overall-price span",b);this.sandbox.dom.html(d,t.call(this,c))},r=function(){var a,b,c,d,f,g={},h=0,i=0;for(var j in this.items)b=this.items[j],c=parseFloat(v.call(this,b)),d=0,b.tax&&b.tax>0&&b.tax<=100&&(a=parseFloat(b.tax),d=c/100*a,g[a]=g[a]?g[a]+d:d),h+=c,i+=c+d;if(f=this.$find(e.globalPriceTableClass),this.sandbox.dom.html(f,""),Object.keys(this.items).length>0){s.call(this,f,this.sandbox.translate("salescore.item.net-price"),u.call(this,h));for(var j in g)s.call(this,f,this.sandbox.translate("salescore.item.vat")+".("+j+"%)",u.call(this,g[j]));s.call(this,f,this.sandbox.translate("salescore.item.overall-price"),u.call(this,i))}},s=function(a,b,c){var d=this.sandbox.dom.createElement(g.priceRow.call(this,b,c));this.sandbox.dom.append(a,d)},t=function(a,b){return u.call(this,v.call(this,a,b),w.call(this,a))},u=function(a,b){return b=b?b:f.currency,this.sandbox.numberFormat(a,"n")+" "+b},v=function(a,b){var c=0;return b&&"default"!==b||a.price&&a.quantity&&(c=a.price*a.quantity,a.discount&&a.discount>0&&a.discount<=100&&(c-=c/100*a.discount)),c},w=function(a){return a.currency?a.currency:f.currency},x=function(a,b){var c=this.sandbox.dom.closest(b.currentTarget,e.rowClass),d=this.sandbox.dom.attr(c,"id"),f={};this.sandbox.start([{name:"loader@husky",options:{el:this.sandbox.dom.find(e.productSearchClass,c),size:"15px"}}]),this.sandbox.util.load(e.productUrl+a.id).then(function(a){f=M.call(this,a),G.call(this,d,f)}.bind(this)).fail(function(a,b,c){this.sandbox.logger.warn(a,b,c)}.bind(this))},y=function(a){this.sandbox.start([{name:"auto-complete@husky",options:{el:this.sandbox.dom.find(e.productSearchClass,a),remoteUrl:e.productsUrl,resultKey:"products",getParameter:"search",value:"",instanceName:"products",valueKey:"name",noNewValues:!0,selectCallback:x.bind(this)}}])},z=function(a){a.preventDefault();var b=this.sandbox.dom.closest(a.currentTarget,".item-table-row"),c=this.sandbox.dom.attr(b,"id");D.call(this,c,b)},A=function(a){delete this.items[a],O.call(this)},B=function(a,b){this.items[a]=b,O.call(this)},C=function(a){a.preventDefault(),J.call(this)},D=function(a,b){this.sandbox.dom.remove(b),this.rowCount--,A.call(this,a),I.call(this,b),r.call(this),this.sandbox.emit(i)},E=function(a,c){c!==!1&&this.rowCount++;var d,g,h=this.sandbox.util.extend({},f,a,{rowId:e.rowIdPrefix+this.rowCount,rowNumber:this.rowCount,isEditable:this.options.editable});return h.overallPrice=t.call(this,h),d=this.sandbox.util.template(b,h),g=this.sandbox.dom.createElement(d),g},F=function(a){var b=E.call(this,a);return this.sandbox.dom.append(this.$find(e.listClass),b),b},G=function(a,b){var c=E.call(this,b,!1);return this.sandbox.dom.replaceWith(this.$find("#"+a),c),B.call(this,a,b),H.call(this,c),this.sandbox.emit(i),c},H=function(a){this.sandbox.form.addField(e.formId,this.sandbox.dom.find(e.quantityInput,a)),this.sandbox.form.addField(e.formId,this.sandbox.dom.find(e.priceInput,a)),this.sandbox.form.addField(e.formId,this.sandbox.dom.find(e.discountInput,a))},I=function(a){this.sandbox.form.removeField(e.formId,this.sandbox.dom.find(e.quantityInput,a)),this.sandbox.form.removeField(e.formId,this.sandbox.dom.find(e.priceInput,a)),this.sandbox.form.removeField(e.formId,this.sandbox.dom.find(e.discountInput,a))},J=function(){var a,b={rowClass:"new"};a=F.call(this,b),y.call(this,a)},K=function(a){this.items=[],this.sandbox.dom.empty(this.table),L.call(this,a)},L=function(a){var b,c,d,e,f;for(b=-1,c=a.length;++b<c;)d=a[b],e=F.call(this,a[b]),f=this.sandbox.dom.attr(e,"id"),this.items[f]=d;O.call(this)},M=function(a){return this.sandbox.util.extend({},f,{name:a.name,number:a.number,product:a})},N=function(){var a=this.sandbox.util.extend({},f,j.call(this)),b=this.sandbox.util.template(c,a);this.sandbox.dom.append(this.$find(e.listClass),b)},O=function(){this.sandbox.dom.data(this.$el,"items",this.getItems())},P=function(){this.sandbox.form.create(e.formId)};return{initialize:function(){this.options=this.sandbox.util.extend({},d,this.options),this.items={},this.rowCount=0,this.table=null,this.isEmpty=this.items.length;var a=this.sandbox.dom.data(this.$el,"items");0===this.options.data.length&&a&&a.length>0&&(this.options.data=a),this.render(),k.call(this),l.call(this)},render:function(){var b=this.sandbox.util.extend({},{addText:this.sandbox.translate("salescore.item.add"),isEditable:this.options.editable},this.options.data);this.table=this.sandbox.util.template(a,b),this.html(this.table),N.call(this),L.call(this,this.options.data),P.call(this),r.call(this)},getItems:function(){var a,b=[];for(a in this.items)b.push(this.items[a]);return b}}});